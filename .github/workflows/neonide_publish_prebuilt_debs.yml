name: NeonIDE - Publish prebuilt .deb(s) to pages APT repo

on:
  workflow_dispatch:
    inputs:
      deb_artifact_name:
        description: "Name of the uploaded artifact that contains .deb files (leave as-is if using artifact upload)"
        required: true
        default: "prebuilt-debs"
      deb_file_path:
        description: "Optional: path to a single .deb already present in this repo checkout (e.g. cmake_4.2.2_aarch64.deb). If set, artifact/URL download steps are skipped."
        required: false
        default: ""
      deb_url:
        description: "Optional: direct URL to a .deb (e.g. GitHub Release asset). If set, artifact download step is skipped."
        required: false
        default: ""
      deb_url_sha256:
        description: "Optional: expected SHA256 for deb_url (integrity check)."
        required: false
        default: ""
      apt_dist:
        description: "APT distribution (dists/<dist>)"
        required: false
        default: "stable"
      apt_component:
        description: "APT component (pool/<component>)"
        required: false
        default: "main"
      apt_arch:
        description: "APT arch directory (binary-<arch>)"
        required: false
        default: "aarch64"
      large_deb_threshold_mb:
        description: "Treat debs >= this size (MiB) as large and publish via GitHub Release assets"
        required: false
        default: "99"
      large_deb_release_tag:
        description: "Git tag/release name to upload large deb assets to"
        required: false
        default: "Packages"
      force_overwrite:
        description: "Overwrite existing debs even if different"
        required: false
        type: boolean
        default: false
      expected_packages:
        description: "Optional: space/newline-separated list of package names expected to be published (others will be skipped)."
        required: false
        default: ""
      fail_on_recipe_mismatch:
        description: "Fail if recipe metadata (maintainer/homepage) mismatches deb control fields."
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout termux-packages
        uses: actions/checkout@v5

      - name: Install host tools
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends dpkg-dev gzip ca-certificates git gnupg gh jq

      - name: Download prebuilt deb artifact
        if: ${{ inputs.deb_file_path == '' && inputs.deb_url == '' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.deb_artifact_name }}
          path: prebuilt-debs

      - name: Download .deb from URL
        if: ${{ inputs.deb_file_path == '' && inputs.deb_url != '' }}
        run: |
          set -euo pipefail
          mkdir -p prebuilt-debs
          url='${{ inputs.deb_url }}'
          echo "Downloading: $url"
          fname="$(basename "$url")"
          curl -LfsS "$url" -o "prebuilt-debs/$fname"
          echo "Downloaded sha256: $(sha256sum "prebuilt-debs/$fname" | awk '{print $1}')"

          if [ -n '${{ inputs.deb_url_sha256 }}' ]; then
            echo "Verifying sha256..."
            echo "${{ inputs.deb_url_sha256 }}  prebuilt-debs/$fname" | sha256sum -c -
          fi

      - name: List downloaded files
        if: ${{ inputs.deb_file_path == '' }}
        run: |
          set -euo pipefail
          find prebuilt-debs -type f -maxdepth 2 -print
          ls -lah prebuilt-debs || true

      - name: Import repo signing key (optional)
        env:
          NEONIDE_GPG_PRIVATE_KEY_B64: ${{ secrets.NEONIDE_GPG_PRIVATE_KEY_B64 }}
          NEONIDE_GPG_KEY_ID: ${{ secrets.NEONIDE_GPG_KEY_ID }}
        run: |
          set -euo pipefail
          if [ -z "${NEONIDE_GPG_PRIVATE_KEY_B64:-}" ] || [ -z "${NEONIDE_GPG_KEY_ID:-}" ]; then
            echo "No signing key configured (NEONIDE_GPG_PRIVATE_KEY_B64/NEONIDE_GPG_KEY_ID missing). Repo will be unsigned."
            exit 0
          fi

          echo "$NEONIDE_GPG_PRIVATE_KEY_B64" | base64 -d | gpg --batch --import
          echo "Secret key is available."
          gpg --batch --list-secret-keys --keyid-format=long "$NEONIDE_GPG_KEY_ID" | sed -n '1,120p'

      - name: Checkout pages repo
        env:
          PAGES_PAT: ${{ secrets.PAGES_PAT }}
        run: |
          set -euo pipefail
          if [ -z "${PAGES_PAT:-}" ]; then
            echo "::error ::Missing secret PAGES_PAT (needs push access to Mart-01-oss/pages.git)"
            exit 1
          fi
          rm -rf pages-repo
          git clone "https://x-access-token:${PAGES_PAT}@github.com/Mart-01-oss/pages.git" pages-repo

      - name: Upload large debs to GitHub Release (if any)
        if: ${{ inputs.deb_file_path == '' && inputs.deb_url == '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          tag='${{ inputs.large_deb_release_tag }}'
          threshold_mb='${{ inputs.large_deb_threshold_mb }}'
          threshold_bytes=$((threshold_mb*1024*1024))

          shopt -s nullglob
          files=(prebuilt-debs/*.deb)
          if [ "${#files[@]}" -eq 0 ]; then
            echo "No debs to consider for release upload."
            exit 0
          fi

          # Determine if there are any large files before creating a release.
          has_large=0
          for f in "${files[@]}"; do
            size="$(stat -c%s "$f")"
            if [ "$size" -ge "$threshold_bytes" ]; then
              has_large=1
              break
            fi
          done
          if [ "$has_large" -ne 1 ]; then
            echo "No large debs (>=${threshold_mb}MiB); skipping release upload."
            exit 0
          fi

          # Ensure release exists
          if gh release view "$tag" >/dev/null 2>&1; then
            echo "[*] Release '$tag' already exists"
          else
            echo "[*] Creating release '$tag'"
            gh release create "$tag" --title "$tag" --notes "Large .deb assets for NeonIDE APT repo." --latest=false
          fi

          assets_json="$(gh api -H 'Accept: application/vnd.github+json' \
            "/repos/${GITHUB_REPOSITORY}/releases/tags/${tag}")"

          for f in "${files[@]}"; do
            size="$(stat -c%s "$f")"
            if [ "$size" -lt "$threshold_bytes" ]; then
              continue
            fi
            name="$(basename "$f")"
            existing_size="$(jq -r --arg n "$name" '.assets[]? | select(.name==$n) | .size' <<<"$assets_json" | head -n1)"
            if [ -n "$existing_size" ] && [ "$existing_size" != "null" ] && [ "$existing_size" = "$size" ]; then
              echo "[=] Release asset already exists (same size), skipping: $name"
              continue
            fi
            echo "[+] Uploading release asset: $name ($size bytes)"
            gh release upload "$tag" "$f" --clobber
          done

      - name: Publish debs into pages APT repo (store small in pages, reference large via release)
        env:
          PAGES_REPO_DIR: ${{ github.workspace }}/pages-repo
          # Either publish a whole dir of debs (artifact or deb_url) or a single deb file path.
          DEBS_DIR: ${{ inputs.deb_file_path == '' && format('{0}/prebuilt-debs', github.workspace) || '' }}
          DEB_FILE: ${{ inputs.deb_file_path != '' && format('{0}/{1}', github.workspace, inputs.deb_file_path) || '' }}
          APT_DIST: ${{ inputs.apt_dist }}
          APT_COMPONENT: ${{ inputs.apt_component }}
          APT_ARCH: ${{ inputs.apt_arch }}
          FORCE_OVERWRITE: ${{ inputs.force_overwrite && 'true' || 'false' }}
          EXPECTED_PACKAGES: ${{ inputs.expected_packages }}
          FAIL_ON_RECIPE_MISMATCH: ${{ inputs.fail_on_recipe_mismatch && 'true' || 'false' }}
          NEONIDE_LARGE_DEB_PUBLISH_MODE: release
          NEONIDE_LARGE_DEB_THRESHOLD_MB: ${{ inputs.large_deb_threshold_mb }}
          # Always reference the canonical repo/tag for large assets
          NEONIDE_LARGE_DEB_RELEASE_BASE_URL: ${{ format('https://github.com/{0}/releases/download/{1}', 'Mart-01-oss/termux-packages', inputs.large_deb_release_tag) }}
          NEONIDE_GPG_KEY_ID: ${{ secrets.NEONIDE_GPG_KEY_ID }}
          NEONIDE_GPG_PASSPHRASE: ${{ secrets.NEONIDE_GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          bash ./scripts/neonide-publish-prebuilt-debs.sh

      - name: Commit & push pages repo changes (if any)
        env:
          PAGES_PAT: ${{ secrets.PAGES_PAT }}
        run: |
          set -euo pipefail
          cd pages-repo
          if [ -z "$(git status --porcelain=v1)" ]; then
            echo "No changes to push."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Publish prebuilt debs (${{ inputs.deb_artifact_name }})"
          git push origin main
