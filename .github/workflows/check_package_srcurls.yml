name: Check package SHA256

on:
  workflow_dispatch:
    inputs:
      scope:
        description: "Scope to check: 'changed' or 'all'"
        type: choice
        required: false
        default: all
        options:
          - all
          - changed
      include_disabled:
        description: "Also check disabled-packages"
        type: boolean
        required: false
        default: false
  pull_request:
    paths:
      - 'packages/**'
      - 'x11-packages/**'
      - 'root-packages/**'
      - 'disabled-packages/**'
      - 'scripts/check-package-sha256.sh'
      - '.github/workflows/check_package_srcurls.yml'
  push:
    branches:
      - master
      - main
      - dev
      - 'dev/**'
    paths:
      - 'packages/**'
      - 'x11-packages/**'
      - 'root-packages/**'
      - 'disabled-packages/**'
      - 'scripts/check-package-sha256.sh'
      - '.github/workflows/check_package_srcurls.yml'

permissions: {} # none

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && format('pr-{0}', github.event.pull_request.number) || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  check-sha256:
    runs-on: ubuntu-24.04
    if: github.event_name != 'workflow_dispatch'
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install jq (needed for changed-scope detection)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Check TERMUX_PKG_SHA256 against TERMUX_PKG_SRCURL
        run: |
          set -euo pipefail
          mkdir -p artifacts/sha256-check
          bash ./scripts/check-package-sha256.sh --scope changed --jobs 16 --output-dir artifacts/sha256-check | tee artifacts/sha256-check/run.log

      - name: Add summary
        if: always()
        run: |
          if [[ -f artifacts/sha256-check/summary.md ]]; then
            cat artifacts/sha256-check/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## SHA256 check (TERMUX_PKG_SHA256 vs TERMUX_PKG_SRCURL)" >> "$GITHUB_STEP_SUMMARY"
            echo "No summary produced." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload SHA256 check report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sha256-check-report
          path: artifacts/sha256-check/
          if-no-files-found: error

  fix-sha256:
    runs-on: ubuntu-24.04
    if: github.event_name == 'workflow_dispatch' && github.repository == 'termux/termux-packages'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install jq (needed for changed-scope detection)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Fix mismatched TERMUX_PKG_SHA256 (logs only when wrong)
        env:
          SCOPE: ${{ github.event.inputs.scope || 'all' }}
          INCLUDE_DISABLED: ${{ github.event.inputs.include_disabled || false }}
        run: |
          set -euo pipefail
          mkdir -p artifacts/sha256-fix
          args=(--scope "$SCOPE" --jobs 16 --output-dir artifacts/sha256-fix --fix)
          if [[ "$INCLUDE_DISABLED" == "true" ]]; then
            args+=(--include-disabled)
          fi
          bash ./scripts/check-package-sha256.sh "${args[@]}" | tee artifacts/sha256-fix/run.log

      - name: Create pull request (if anything changed)
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(packages): update TERMUX_PKG_SHA256"
          title: "fix(packages): update TERMUX_PKG_SHA256"
          body: |
            Automated update of TERMUX_PKG_SHA256 based on TERMUX_PKG_SRCURL.

            Generated by: scripts/check-package-sha256.sh --fix
          branch: "automation/fix-sha256-${{ github.run_id }}"
          delete-branch: true

      - name: Add summary
        if: always()
        run: |
          if [[ -f artifacts/sha256-fix/summary.md ]]; then
            cat artifacts/sha256-fix/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "## SHA256 fix" >> "$GITHUB_STEP_SUMMARY"
            echo "No summary produced." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload SHA256 fix report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sha256-fix-report
          path: artifacts/sha256-fix/
          if-no-files-found: error
