name: NeonIDE - Build & publish APT repo (aarch64)

on:
  workflow_dispatch:
    inputs:
      batch_size:
        description: "Max number of source packages to build per run (keeps workflow under GitHub limits)"
        required: false
        default: "25"
      force_rebuild:
        description: "Rebuild even if .deb exists and SHA256 matches current Packages"
        required: false
        type: boolean
        default: false

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Disk space (before)
        run: |
          set -euo pipefail
          df -h

      # Reuse approach from neonide_bootstrap.yml
      - name: Free disk space (lightweight)
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          df -h

      - name: Move Docker data-root to /mnt/docker
        run: |
          set -euo pipefail
          DOCKER_ROOT="/mnt/docker"
          sudo systemctl stop docker
          sudo mkdir -p "$DOCKER_ROOT"
          if [ -d /var/lib/docker ] && [ -n "$(ls -A /var/lib/docker 2>/dev/null || true)" ]; then
            sudo rsync -aHAX --delete /var/lib/docker/ "$DOCKER_ROOT/" || true
          fi
          echo "{\"data-root\": \"$DOCKER_ROOT\"}" | sudo tee /etc/docker/daemon.json
          sudo systemctl start docker
          docker info | sed -n '1,120p'
          df -h

      - name: Checkout termux-packages
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Install host tools for repo generation
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends dpkg-dev gzip ca-certificates git gnupg

      - name: Import repo signing key (optional)
        env:
          NEONIDE_GPG_PRIVATE_KEY_B64: ${{ secrets.NEONIDE_GPG_PRIVATE_KEY_B64 }}
          NEONIDE_GPG_KEY_ID: ${{ secrets.NEONIDE_GPG_KEY_ID }}
        run: |
          set -euo pipefail
          if [ -z "${NEONIDE_GPG_PRIVATE_KEY_B64:-}" ] || [ -z "${NEONIDE_GPG_KEY_ID:-}" ]; then
            echo "No signing key configured (NEONIDE_GPG_PRIVATE_KEY_B64/NEONIDE_GPG_KEY_ID missing). Repo will be unsigned."
            exit 0
          fi

          # Import private key (base64 encoded ASCII-armored export)
          echo "$NEONIDE_GPG_PRIVATE_KEY_B64" | base64 -d | gpg --batch --import

          # IMPORTANT: Do not use 'gpg --edit-key' here (it becomes interactive on newer gpg).
          # Trust is not required for signing with an available secret key.
          echo "Secret key is available."
          gpg --batch --list-secret-keys --keyid-format=long "$NEONIDE_GPG_KEY_ID" | sed -n '1,120p'

      - name: Checkout pages repo
        env:
          PAGES_PAT: ${{ secrets.PAGES_PAT }}
        run: |
          set -euo pipefail
          if [ -z "${PAGES_PAT:-}" ]; then
            echo "::error ::Missing secret PAGES_PAT (needs push access to Mart-01-oss/pages.git)"
            exit 1
          fi
          rm -rf pages-repo
          git clone "https://x-access-token:${PAGES_PAT}@github.com/Mart-01-oss/pages.git" pages-repo

      - name: Ensure Android SDK/NDK available in docker
        env:
          TERMUX_DOCKER__HOST_TERMUX_TOPDIR: /mnt/termux-topdir
        run: |
          set -euo pipefail
          sudo mkdir -p /mnt/termux-topdir
          sudo chown -R "$USER:$USER" /mnt/termux-topdir
          ./scripts/run-docker.sh bash -lc 'set -euo pipefail; cd "$HOME/termux-packages"; . ./scripts/properties.sh; if [ ! -d "$NDK" ]; then echo "NDK missing in container at $NDK, running setup-android-sdk.sh"; ./scripts/setup-android-sdk.sh; fi'

      - name: Build missing packages & update repo metadata
        env:
          PAGES_REPO_DIR: ${{ github.workspace }}/pages-repo
          TERMUX_ARCH: aarch64
          BATCH_SIZE: ${{ inputs.batch_size }}
          FORCE_REBUILD: ${{ inputs.force_rebuild && 'true' || 'false' }}
          # Use runner disk (/mnt) for TERMUX_TOPDIR inside container to avoid docker overlay disk exhaustion
          TERMUX_DOCKER__HOST_TERMUX_TOPDIR: /mnt/termux-topdir
          # Exclude "termux core" (bootstrap) packages list
          EXCLUDE_BOOTSTRAP_LIST: ${{ github.workspace }}/scripts/neonide-bootstrap-packages.txt
          # Desired list: build all package recipes (incremental batches)
          DESIRED_PACKAGES_SOURCE: recipes
          # Allow using unsigned repo metadata for custom pages repo (fallback official repo still verified)
          TERMUX_ALLOW_UNVERIFIED_REPOS: "true"
          # IMPORTANT: Do NOT fall back to official Termux repositories when building for
          # com.neonide.studio. Official Termux debs install to /data/data/com.termux/files/usr,
          # which leads to missing headers/libs under the NeonIDE prefix during builds.
          TERMUX_USE_OFFICIAL_REPO_FALLBACK: "false"
          # Optional signing
          NEONIDE_GPG_KEY_ID: ${{ secrets.NEONIDE_GPG_KEY_ID }}
          NEONIDE_GPG_PASSPHRASE: ${{ secrets.NEONIDE_GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          sudo mkdir -p /mnt/termux-topdir
          sudo chown -R "$USER:$USER" /mnt/termux-topdir
          ./scripts/neonide-build-and-publish-pages.sh

      - name: Commit & push pages repo changes (if any)
        env:
          PAGES_PAT: ${{ secrets.PAGES_PAT }}
        run: |
          set -euo pipefail
          cd pages-repo
          if [ -z "$(git status --porcelain=v1)" ]; then
            echo "No changes to push."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Update aarch64 repo (batch build)"
          git push origin main

      - name: Docker cleanup (always)
        if: always()
        run: |
          set -euo pipefail
          docker system prune -af --volumes || true
          df -h
