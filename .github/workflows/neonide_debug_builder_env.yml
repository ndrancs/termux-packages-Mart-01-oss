name: NeonIDE - Debug docker builder env

on:
  workflow_dispatch:

permissions: {}

jobs:
  debug:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Disk space (before)
        run: |
          set -euo pipefail
          df -h

      - name: Free disk space (lightweight)
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          df -h

      - name: Move Docker data-root to /mnt/docker
        run: |
          set -euo pipefail
          DOCKER_ROOT="/mnt/docker"
          sudo systemctl stop docker
          sudo mkdir -p "$DOCKER_ROOT"
          if [ -d /var/lib/docker ] && [ -n "$(ls -A /var/lib/docker 2>/dev/null || true)" ]; then
            sudo rsync -aHAX --delete /var/lib/docker/ "$DOCKER_ROOT/" || true
          fi
          echo "{\"data-root\": \"$DOCKER_ROOT\"}" | sudo tee /etc/docker/daemon.json
          sudo systemctl start docker
          docker info | sed -n '1,120p'
          df -h

      - name: Checkout termux-packages
        uses: actions/checkout@v5

      - name: Show selected TERMUX_HOST_LLVM settings (from properties.sh)
        run: |
          set -euo pipefail
          echo "TERMUX_HOST_LLVM_MAJOR_VERSION from properties.sh:"
          grep -n "TERMUX_HOST_LLVM_MAJOR_VERSION" -n scripts/properties.sh | head -n 5 || true
          grep -n "TERMUX_HOST_LLVM_BASE_DIR" -n scripts/properties.sh | head -n 5 || true

      - name: Ensure Android SDK/NDK available in docker
        env:
          TERMUX_DOCKER__HOST_TERMUX_TOPDIR: /mnt/termux-topdir
        run: |
          set -euo pipefail
          mkdir -p /mnt/termux-topdir
          ./scripts/run-docker.sh bash -lc 'set -euo pipefail; cd "$HOME/termux-packages"; . ./scripts/properties.sh; if [ ! -d "$NDK" ]; then echo "NDK missing in container at $NDK, running setup-android-sdk.sh"; ./scripts/setup-android-sdk.sh; fi'

      - name: Probe LLVM/Clang paths inside docker builder
        run: |
          set -euo pipefail
          ./scripts/run-docker.sh bash -lc '
            set -euo pipefail
            echo "=== uname ==="; uname -a
            echo "=== whoami ==="; whoami
            echo "=== PATH ==="; echo "$PATH"

            echo "=== clang in PATH? ==="
            command -v clang || true
            clang --version 2>/dev/null | head -n 5 || true

            echo "=== /usr/lib/llvm-* dirs ==="
            ls -1d /usr/lib/llvm-* 2>/dev/null || true

            echo "=== clang binaries under /usr/lib/llvm-*/bin ==="
            for d in /usr/lib/llvm-*; do
              [ -d "$d" ] || continue
              if [ -x "$d/bin/clang" ]; then
                echo "FOUND: $d/bin/clang"
                "$d/bin/clang" --version | head -n 2 || true
              fi
            done

            echo "=== check /usr/bin/clang ==="
            ls -la /usr/bin/clang 2>/dev/null || true
            echo "=== check /usr/bin/clang-* ==="
            ls -la /usr/bin/clang* 2>/dev/null | head -n 50 || true

            echo "=== check common Termux host llvm base dirs ==="
            for base in /usr /usr/lib/llvm-19 /usr/lib/llvm-18 /usr/lib/llvm-17; do
              if [ -x "$base/bin/clang" ]; then
                echo "OK: $base/bin/clang exists"
              else
                echo "NO: $base/bin/clang missing"
              fi
            done
          '

      - name: Docker cleanup (always)
        if: always()
        run: |
          set -euo pipefail
          docker system prune -af --volumes || true
          df -h
