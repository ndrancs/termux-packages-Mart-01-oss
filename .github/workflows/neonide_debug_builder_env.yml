name: NeonIDE - Debug docker builder env

on:
  workflow_dispatch:

permissions: {}

jobs:
  debug:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Disk space (before)
        run: |
          set -euo pipefail
          df -h

      - name: Free disk space (lightweight)
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          df -h

      - name: Move Docker data-root to /mnt/docker
        run: |
          set -euo pipefail
          DOCKER_ROOT="/mnt/docker"
          sudo systemctl stop docker
          sudo mkdir -p "$DOCKER_ROOT"
          if [ -d /var/lib/docker ] && [ -n "$(ls -A /var/lib/docker 2>/dev/null || true)" ]; then
            sudo rsync -aHAX --delete /var/lib/docker/ "$DOCKER_ROOT/" || true
          fi
          echo "{\"data-root\": \"$DOCKER_ROOT\"}" | sudo tee /etc/docker/daemon.json
          sudo systemctl start docker
          docker info | sed -n '1,120p'
          df -h

      - name: Checkout termux-packages
        uses: actions/checkout@v5

      - name: Install host debug tools (gnupg)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends gnupg coreutils
          gpg --version | sed -n '1,40p'

      - name: Debug GPG signing/passphrase (repo metadata)
        env:
          NEONIDE_GPG_PRIVATE_KEY_B64: ${{ secrets.NEONIDE_GPG_PRIVATE_KEY_B64 }}
          NEONIDE_GPG_KEY_ID: ${{ secrets.NEONIDE_GPG_KEY_ID }}
          NEONIDE_GPG_PASSPHRASE: ${{ secrets.NEONIDE_GPG_PASSPHRASE }}
        run: |
          set -euo pipefail

          echo "=== GPG env presence (do not print secrets) ==="
          if [ -n "${NEONIDE_GPG_PRIVATE_KEY_B64:-}" ]; then echo "NEONIDE_GPG_PRIVATE_KEY_B64: set"; else echo "NEONIDE_GPG_PRIVATE_KEY_B64: NOT set"; fi
          if [ -n "${NEONIDE_GPG_KEY_ID:-}" ]; then echo "NEONIDE_GPG_KEY_ID: set ($NEONIDE_GPG_KEY_ID)"; else echo "NEONIDE_GPG_KEY_ID: NOT set"; fi
          if [ -n "${NEONIDE_GPG_PASSPHRASE:-}" ]; then echo "NEONIDE_GPG_PASSPHRASE: set (len=${#NEONIDE_GPG_PASSPHRASE})"; else echo "NEONIDE_GPG_PASSPHRASE: NOT set"; fi

          if [ -z "${NEONIDE_GPG_PRIVATE_KEY_B64:-}" ] || [ -z "${NEONIDE_GPG_KEY_ID:-}" ]; then
            echo "No signing secrets configured; skipping GPG debug.";
            exit 0
          fi

          echo "=== Import private key ==="
          echo "$NEONIDE_GPG_PRIVATE_KEY_B64" | base64 -d | gpg --batch --import

          echo "=== List secret keys (sanitized) ==="
          gpg --batch --list-secret-keys --keyid-format=long "$NEONIDE_GPG_KEY_ID" | sed -n '1,120p'

          echo "=== Test non-interactive signing (expected to FAIL if key needs passphrase) ==="
          tmpdir="$(mktemp -d)"
          trap 'rm -rf "$tmpdir"' EXIT
          echo "test payload $(date -Ru)" > "$tmpdir/payload.txt"

          set +e
          gpg --batch --yes --local-user "$NEONIDE_GPG_KEY_ID" --clearsign -o "$tmpdir/payload.txt.asc" "$tmpdir/payload.txt"
          rc=$?
          set -e
          echo "sign-without-passphrase exit code: $rc"

          if [ -n "${NEONIDE_GPG_PASSPHRASE:-}" ]; then
            echo "=== Test non-interactive signing WITH loopback passphrase (should succeed) ==="
            gpg --batch --yes --pinentry-mode loopback --passphrase "$NEONIDE_GPG_PASSPHRASE" --local-user "$NEONIDE_GPG_KEY_ID" --clearsign -o "$tmpdir/payload.loopback.asc" "$tmpdir/payload.txt"
            echo "loopback signing OK; output preview:"
            sed -n '1,20p' "$tmpdir/payload.loopback.asc" || true
          else
            echo "Passphrase secret not set; cannot test loopback signing success path."
          fi

      - name: Show selected TERMUX_HOST_LLVM settings (from properties.sh)
        run: |
          set -euo pipefail
          echo "TERMUX_HOST_LLVM_MAJOR_VERSION from properties.sh:"
          grep -n "TERMUX_HOST_LLVM_MAJOR_VERSION" -n scripts/properties.sh | head -n 5 || true
          grep -n "TERMUX_HOST_LLVM_BASE_DIR" -n scripts/properties.sh | head -n 5 || true

      - name: Ensure Android SDK/NDK available in docker
        env:
          TERMUX_DOCKER__HOST_TERMUX_TOPDIR: /mnt/termux-topdir
        run: |
          set -euo pipefail
          sudo mkdir -p /mnt/termux-topdir
          sudo chown -R "$USER:$USER" /mnt/termux-topdir
          ./scripts/run-docker.sh bash -lc 'set -euo pipefail; cd "$HOME/termux-packages"; . ./scripts/properties.sh; if [ ! -d "$NDK" ]; then echo "NDK missing in container at $NDK, running setup-android-sdk.sh"; ./scripts/setup-android-sdk.sh; fi'

      - name: Probe LLVM/Clang paths inside docker builder
        run: |
          set -euo pipefail
          ./scripts/run-docker.sh bash -lc '
            set -euo pipefail
            echo "=== uname ==="; uname -a
            echo "=== whoami ==="; whoami
            echo "=== PATH ==="; echo "$PATH"

            echo "=== clang in PATH? ==="
            command -v clang || true
            clang --version 2>/dev/null | head -n 5 || true

            echo "=== /usr/lib/llvm-* dirs ==="
            ls -1d /usr/lib/llvm-* 2>/dev/null || true

            echo "=== clang binaries under /usr/lib/llvm-*/bin ==="
            for d in /usr/lib/llvm-*; do
              [ -d "$d" ] || continue
              if [ -x "$d/bin/clang" ]; then
                echo "FOUND: $d/bin/clang"
                "$d/bin/clang" --version | head -n 2 || true
              fi
            done

            echo "=== check /usr/bin/clang ==="
            ls -la /usr/bin/clang 2>/dev/null || true
            echo "=== check /usr/bin/clang-* ==="
            ls -la /usr/bin/clang* 2>/dev/null | head -n 50 || true

            echo "=== check common Termux host llvm base dirs ==="
            for base in /usr /usr/lib/llvm-19 /usr/lib/llvm-18 /usr/lib/llvm-17; do
              if [ -x "$base/bin/clang" ]; then
                echo "OK: $base/bin/clang exists"
              else
                echo "NO: $base/bin/clang missing"
              fi
            done
          '

      - name: Debug JsonCpp detection (reproduce cmake configure + inspect prefix)
        run: |
          set -euo pipefail
          ./scripts/run-docker.sh bash -lc '
            set -euo pipefail
            cd "$HOME/termux-packages"

            # Match neonide-build-and-publish-pages.sh behavior so -i is not ignored.
            export TERMUX_REPO_APP__PACKAGE_NAME="com.neonide.studio"

            # Optional: allow unsigned repos + add official Termux repo as fallback
            export TERMUX_ALLOW_UNVERIFIED_REPOS="true"
            export TERMUX_EXTRA_REPO_URL="https://packages-cf.termux.dev/apt/termux-main"
            export TERMUX_EXTRA_REPO_DISTRIBUTION="stable"
            export TERMUX_EXTRA_REPO_COMPONENT="main"

            . ./scripts/properties.sh

            echo "=== Termux app package / prefix ==="
            echo "TERMUX_APP_PACKAGE=${TERMUX_APP_PACKAGE:-}"
            echo "TERMUX_REPO_APP__PACKAGE_NAME=${TERMUX_REPO_APP__PACKAGE_NAME:-}"
            echo "TERMUX_PREFIX=${TERMUX_PREFIX:-}"

            echo "=== STEP 1: Trigger dependency extraction by attempting cmake build (expected to fail) ==="
            set +e
            ./build-package.sh -i -a aarch64 cmake
            rc=$?
            set -e
            echo "cmake build exit code: $rc (expected non-zero while debugging)"

            echo "=== STEP 2: Inspect jsoncpp/rhash under TERMUX_PREFIX (after dependency extraction) ==="
            echo "--- lib dir ---"
            ls -la "${TERMUX_PREFIX}/lib" 2>/dev/null | head -n 200 || true

            echo "--- json include dir ---"
            ls -la "${TERMUX_PREFIX}/include/json" 2>/dev/null | head -n 200 || true
            for f in json.h json_features.h features.h version.h; do
              if [ -e "${TERMUX_PREFIX}/include/json/$f" ]; then
                echo "OK: ${TERMUX_PREFIX}/include/json/$f exists"
              else
                echo "MISSING: ${TERMUX_PREFIX}/include/json/$f"
              fi
            done

            echo "--- jsoncpp compatibility include dir ---"
            ls -la "${TERMUX_PREFIX}/include/jsoncpp/json" 2>/dev/null | head -n 200 || true

            echo "--- rhash headers ---"
            find "${TERMUX_PREFIX}/include" -maxdepth 3 -type f 2>/dev/null | grep -i rhash | head -n 80 || true

            echo "=== STEP 3: Dump CMakeCache and error logs from the failing build (if present) ==="
            find "$HOME/.termux-build" -path "*cmake*" -name CMakeCache.txt -print -exec sh -lc "echo '--- '; tail -n 120 \"$1\"" _ {} \; 2>/dev/null || true
            find "$HOME/.termux-build" -path "*cmake*" -name CMakeError.log -print -exec sh -lc "echo '--- '; tail -n 200 \"$1\"" _ {} \; 2>/dev/null || true
          '

      - name: Docker cleanup (always)
        if: always()
        run: |
          set -euo pipefail
          docker system prune -af --volumes || true
          df -h
