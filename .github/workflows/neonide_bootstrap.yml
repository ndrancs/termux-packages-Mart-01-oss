name: Build NeonIDE bootstrap

on:
  workflow_dispatch:
    inputs:
      app_package:
        description: "Android applicationId/package name"
        required: false
        default: "com.neonide.studio"
      arch:
        description: "Architecture to build"
        required: false
        default: "aarch64"
      android10:
        description: "Build Android 10+ bootstrap"
        required: false
        type: boolean
        default: true
      include_extra_packages:
        description: "Include extra packages from scripts/neonide-bootstrap-packages.txt"
        required: false
        type: boolean
        default: false

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Disk space (before)
        run: |
          set -euo pipefail
          df -h

      # GitHub-hosted runners come with a lot of preinstalled toolchains that consume disk.
      # The docker builder image is large and by default is stored under /var/lib/docker on the root filesystem.
      # Free some space and then relocate docker storage under the workspace to avoid filling '/'.
      - name: Free disk space (lightweight)
        run: |
          set -euo pipefail
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
          sudo apt-get clean || true
          sudo rm -rf /var/lib/apt/lists/* || true
          df -h

      # IMPORTANT: Store docker image layers on the workspace disk instead of /var/lib/docker.
      # This avoids "docker: write /var/lib/docker/tmp/...: no space left on device".
      - name: Move Docker data-root to workspace
        run: |
          set -euo pipefail
          DOCKER_ROOT="$GITHUB_WORKSPACE/.docker"
          sudo systemctl stop docker
          sudo mkdir -p "$DOCKER_ROOT"
          # If docker had already been used, migrate old state to the new root.
          if [ -d /var/lib/docker ] && [ -n "$(ls -A /var/lib/docker 2>/dev/null || true)" ]; then
            sudo rsync -aHAX --delete /var/lib/docker/ "$DOCKER_ROOT/" || true
          fi
          echo "{\"data-root\": \"$DOCKER_ROOT\"}" | sudo tee /etc/docker/daemon.json
          sudo systemctl start docker
          docker info | sed -n '1,120p'
          df -h

      - name: Checkout
        uses: actions/checkout@v5

      - name: Build bootstrap zip
        run: |
          set -euo pipefail

          args=(
            --app-package "${{ inputs.app_package }}"
            --arch "${{ inputs.arch }}"
          )

          if [ "${{ inputs.include_extra_packages }}" = "true" ]; then
            args+=(--packages-file scripts/neonide-bootstrap-packages.txt)
          fi

          if [ "${{ inputs.android10 }}" != "true" ]; then
            args+=(--no-android10)
          fi

          ./build-neonide-bootstrap.sh "${args[@]}"

      - name: List produced zips
        run: |
          set -euo pipefail
          ls -lah ./*.zip

      - name: Upload bootstrap zip
        uses: actions/upload-artifact@v4
        with:
          name: neonide-bootstrap-${{ inputs.arch }}-${{ github.sha }}
          path: bootstrap-*.zip
          if-no-files-found: error

      - name: Docker cleanup (always)
        if: always()
        run: |
          set -euo pipefail
          docker system prune -af --volumes || true
          df -h
