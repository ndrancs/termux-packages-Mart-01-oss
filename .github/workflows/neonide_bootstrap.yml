name: Build NeonIDE bootstrap

on:
  workflow_dispatch:
    inputs:
      app_package:
        description: "Android applicationId/package name"
        required: false
        default: "com.neonide.studio"
      arch:
        description: "Architecture to build"
        required: false
        default: "aarch64"
      android10:
        description: "Build Android 10+ bootstrap"
        required: false
        type: boolean
        default: true
      include_extra_packages:
        description: "Include extra packages from scripts/neonide-bootstrap-packages.txt"
        required: false
        type: boolean
        default: false

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Disk space (before)
        run: |
          set -euo pipefail
          df -h

      # GitHub-hosted runners come with a lot of preinstalled toolchains that consume disk.
      # Bootstrap builds can be large; free space early to avoid the runner itself crashing
      # with "No space left on device" while writing diagnostic logs.
      - name: Maximize build space
        uses: easimon/maximize-build-space@v10
        with:
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          # Keep a small reserve so the system/runner can still write logs.
          root-reserve-mb: 5120
          temp-reserve-mb: 1024

      - name: Disk space (after maximize)
        run: |
          set -euo pipefail
          df -h

      - name: Checkout
        uses: actions/checkout@v5

      - name: Build bootstrap zip
        run: |
          set -euo pipefail

          args=(
            --app-package "${{ inputs.app_package }}"
            --arch "${{ inputs.arch }}"
          )

          if [ "${{ inputs.include_extra_packages }}" = "true" ]; then
            args+=(--packages-file scripts/neonide-bootstrap-packages.txt)
          fi

          if [ "${{ inputs.android10 }}" != "true" ]; then
            args+=(--no-android10)
          fi

          ./build-neonide-bootstrap.sh "${args[@]}"

      - name: List produced zips
        run: |
          set -euo pipefail
          ls -lah ./*.zip

      - name: Upload bootstrap zip
        uses: actions/upload-artifact@v4
        with:
          name: neonide-bootstrap-${{ inputs.arch }}-${{ github.sha }}
          path: bootstrap-*.zip
          if-no-files-found: error

      - name: Docker cleanup (always)
        if: always()
        run: |
          set -euo pipefail
          docker system prune -af --volumes || true
          df -h
