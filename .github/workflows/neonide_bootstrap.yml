name: Build NeonIDE bootstrap

on:
  workflow_dispatch:
    inputs:
      app_package:
        description: "Android applicationId/package name"
        required: false
        default: "com.neonide.studio"
      arch:
        description: "Architecture to build"
        required: false
        default: "aarch64"
      android10:
        description: "Build Android 10+ bootstrap"
        required: false
        type: boolean
        default: true
      repo_url:
        description: "APT repository base URL (must contain requested packages)"
        required: false
        default: "https://packages-cf.termux.dev/apt/termux-main"

permissions: {}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Free additional disk space (if needed)
        run: |
          set -euo pipefail
          ./scripts/free-space.sh

      # Use the no-compile generator (downloads packages from repo) to avoid
      # running full package builds and running out of disk space.
      - name: Build bootstrap zip
        run: |
          set -euo pipefail

          args=(
            --app-package "${{ inputs.app_package }}"
            --arch "${{ inputs.arch }}"
            --repo "${{ inputs.repo_url }}"
          )

          if [ "${{ inputs.android10 }}" != "true" ]; then
            args+=(--no-android10)
          fi

          ./build-neonide-bootstrap-from-repo.sh "${args[@]}"

      - name: List produced zips
        run: |
          set -euo pipefail
          ls -lah ./*.zip

      - name: Upload bootstrap zip
        uses: actions/upload-artifact@v4
        with:
          name: neonide-bootstrap-${{ inputs.arch }}-${{ github.sha }}
          path: bootstrap-*.zip
          if-no-files-found: error
