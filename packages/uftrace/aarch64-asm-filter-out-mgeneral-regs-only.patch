--- a/arch/aarch64/Makefile
+++ b/arch/aarch64/Makefile
@@ -21,11 +21,19 @@ $(odir)/uftrace-arch.a: $(ARCH_UFTRACE_OBJS)
 	$(QUIET_AR)$(AR) $(ARFLAGS) $@ $^
 
 $(odir)/%.op: $(sdir)/%.S
-	$(QUIET_ASM)$(CC) $(LIB_CFLAGS) -c -o $@ $<
+	# uftrace may append '-mgeneral-regs-only' to LIB_CFLAGS (via check-deps)
+	# when the compiler supports it. That option disables the FP/SIMD register
+	# file for AArch64 and makes the assembler reject instructions using d0/d1
+	# (e.g. "instruction requires: fp-armv8").
+	$(QUIET_ASM)$(CC) $(filter-out -mgeneral-regs-only,$(LIB_CFLAGS)) -c -o $@ $<
 
 $(odir)/%.op: $(sdir)/%.c
-	$(QUIET_CC_FPIC)$(CC) $(LIB_CFLAGS) -c -o $@ $<
+	# Some arch/aarch64 sources (e.g. mcount-support.c) use inline asm that
+	# explicitly accesses FP/SIMD registers (s0/d0/...). Filter out
+	# '-mgeneral-regs-only' here as well.
+	$(QUIET_CC_FPIC)$(CC) $(filter-out -mgeneral-regs-only,$(LIB_CFLAGS)) -c -o $@ $<
